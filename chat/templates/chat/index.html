<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #chat-window {
            height: 70vh;
        }
        .message {
            max-width: 80%;
        }
        .user-message {
            align-self: flex-end;
            background-color: #2563eb; /* blue-600 */
            color: white;
        }
        .bot-message {
            align-self: flex-start;
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
        }
        .source-tag {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 4px;
        }
        /* --- MCQ Styling --- */
        .mcq-option-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            background-color: white;
            transition: background-color 0.2s;
        }
        .mcq-option-btn:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .mcq-option-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .mcq-option-btn.correct {
            background-color: #d1fae5; /* green-100 */
            border-color: #6ee7b7; /* green-300 */
        }
        .mcq-option-btn.incorrect {
            background-color: #fee2e2; /* red-100 */
            border-color: #fca5a5; /* red-300 */
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">

    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl flex overflow-hidden" style="height: 85vh;">
        
        <!-- Chat Column -->
        <div class="w-2/3 flex flex-col border-r border-gray-200">
            <div class="p-4 border-b">
                <h1 class="text-2xl font-bold text-gray-800">RAG Document Chat</h1>
                <p class="text-sm text-gray-500">Ask questions about your documents.</p>
            </div>
            
            <div id="chat-window" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-4">
                <!-- Chat messages will be appended here -->
                <div class="message bot-message rounded-lg p-3 shadow">
                    Hello! Ask me a question about the documents you've loaded.
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50">
                <form id="chat-form" class="flex space-x-2">
                    <input type="text" id="message-input" placeholder="Type your message..."
                           class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" id="send-btn"
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition">
                        Send
                    </button>
                </form>
            </div>
        </div>

        <!-- MCQ Column -->
        <div class="w-1/3 flex flex-col bg-gray-50">
            <div class="p-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">MCQ Generator</h2>
            </div>
            
            <div class="p-4 flex-1 overflow-y-auto">
                <div class="flex flex-col space-y-4">
                    <input type="text" id="mcq-topic-input" placeholder="Optional: Enter a topic"
                           class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    
                    <button id="generate-mcq-btn"
                            class="w-full px-4 py-3 bg-green-600 text-white rounded-lg font-semibold shadow hover:bg-green-700 transition">
                        Generate MCQ
                    </button>
                </div>

                <hr class="my-6 border-gray-300">

                <!-- MCQ will be displayed here -->
                <div id="mcq-container" class="space-y-3">
                    <div id="mcq-loading" class="text-center text-gray-500 hidden">
                        <svg class="animate-spin h-5 w-5 text-gray-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Generating...
                    </div>
                    <h3 id="mcq-question" class="text-lg font-semibold text-gray-800"></h3>
                    <div id="mcq-options" class="space-y-2">
                        <!-- Options will be appended here -->
                    </div>
                    <div id="mcq-feedback" class="mt-3 text-sm font-medium">
                        <!-- Feedback will be shown here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        
        const generateMcqBtn = document.getElementById('generate-mcq-btn');
        const mcqTopicInput = document.getElementById('mcq-topic-input');
        const mcqContainer = document.getElementById('mcq-container');
        const mcqLoading = document.getElementById('mcq-loading');
        const mcqQuestion = document.getElementById('mcq-question');
        const mcqOptions = document.getElementById('mcq-options');
        const mcqFeedback = document.getElementById('mcq-feedback');

        let currentMCQ = null; // Store the current MCQ's data

        // --- Chat Form Submission ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            messageInput.value = '';
            sendBtn.disabled = true;
            sendBtn.innerText = '...';

            try {
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                addMessage(data.answer, 'bot', data.sources);

            } catch (error) {
                console.error('Chat API Error:', error);
                addMessage('Sorry, something went wrong. Please try again.', 'bot');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerText = 'Send';
            }
        });

        function addMessage(text, sender, sources = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message rounded-lg p-3 shadow`;
            
            let sourceTags = '';
            if (sources.length > 0) {
                sourceTags = '<div class="mt-2 border-t pt-2">';
                sources.forEach(source => {
                    sourceTags += `<span class="source-tag">${source.source} (p. ${source.page})</span>`;
                });
                sourceTags += '</div>';
            }
            
            // Format newlines
            text = text.replace(/\n/g, '<br>');

            messageDiv.innerHTML = text + sourceTags;
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- MCQ Generation ---
        generateMcqBtn.addEventListener('click', generateMCQ);

        async function generateMCQ() {
            const topic = mcqTopicInput.value.trim() || 'a key concept from the document';
            
            // Reset UI
            mcqLoading.classList.remove('hidden');
            mcqQuestion.innerText = '';
            mcqOptions.innerHTML = '';
            mcqFeedback.innerHTML = '';
            currentMCQ = null;
            generateMcqBtn.disabled = true;

            try {
                const response = await fetch('/api/mcq/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topic })
                });

                const data = await response.json();

                if (!response.ok) {
                    // This handles the 'no_questions' error from the backend
                    throw new Error(data.error || 'Failed to generate MCQ');
                }

                currentMCQ = data; // Store the full MCQ data
                displayMCQ(data);

            } catch (error) {
                console.error('MCQ API Error:', error);
                mcqFeedback.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
            } finally {
                mcqLoading.classList.add('hidden');
                generateMcqBtn.disabled = false;
            }
        }

        function displayMCQ(data) {
            mcqQuestion.innerText = data.question;
            mcqOptions.innerHTML = ''; // Clear old options
            
            data.options.forEach(option => {
                const button = document.createElement('button');
                button.innerText = option;
                button.className = 'mcq-option-btn';
                button.onclick = () => checkMCQAnswer(button, option);
                mcqOptions.appendChild(button);
            });
        }

        // --- FEATURE 1: Check MCQ Answer (Frontend Logic) ---
        function checkMCQAnswer(button, selectedOption) {
            if (!currentMCQ) return; // No question loaded

            // Disable all buttons
            const buttons = mcqOptions.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);

            const feedbackDiv = mcqFeedback;
            
            if (selectedOption === currentMCQ.correct_answer) {
                button.classList.add('correct');
                feedbackDiv.innerHTML = '<strong class="text-green-600">Correct!</strong>';
            } else {
                button.classList.add('incorrect');
                feedbackDiv.innerHTML = `<strong class="text-red-600">Incorrect.</strong> The correct answer was: <br><strong>${currentMCQ.correct_answer}</strong>`;
                
                // Highlight the correct answer
                buttons.forEach(btn => {
                    if (btn.innerText === currentMCQ.correct_answer) {
                        btn.classList.add('correct');
                    }
                });
            }

            // --- FEATURE 2: Display Page Reference ---
            feedbackDiv.innerHTML += `<br><span class="text-xs text-gray-500 mt-1 block">Source: Page ${currentMCQ.page}</span>`;
        }
    </script>
</body>
</html>

